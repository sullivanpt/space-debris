<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset='utf-8'>

  <title>Space Debris</title>
  <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/donmccurdy/aframe-physics-system/v2.1.0/dist/aframe-physics-system.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.4/lodash.min.js"></script>
</head>

<body>
  <script>
    /**
     * like force-pushable but positions object at camera
     */
    AFRAME.registerComponent('missile-start', {
      schema: {
        force: { default: 10 }
      },
      init: function () {
        this.pStart = new THREE.Vector3()
        this.sourceEl = this.el.sceneEl.querySelector('[camera]')
        window.addEventListener('click', _.throttle(this.forcePush.bind(this), 1000, { trailing: false }))
      },
      forcePush: function () {
        var force
        el = this.el

        // Compute direction of force, normalize, then scale.
        // force = (new CANNON.Vec3()).copy(this.sourceEl.object3D.getWorldDirection()),
        force = new THREE.Vector3(0, 0, - 1);
        // Now, apply the same rotation to the vector that is applied to the camera:
        force.applyQuaternion(this.sourceEl.object3D.quaternion)
        force = (new CANNON.Vec3()).copy(force)

        force.normalize()
        force.scale(this.data.force, force)

        el.body.position.copy(this.sourceEl.getAttribute('position'))
        el.body.velocity.copy(force)
        el.body.angularVelocity.set(12, 6, 3)

        el.components.sound.playSound()
      }
    })
    AFRAME.registerComponent('missile-collider', {
      init: function () {
        this.soundEl = this.el.sceneEl.querySelector('#rockExplosion')
        this.el.addEventListener('collide', this.collide.bind(this))
      },
      collide: function (e) {
        // seems to be a bug playing same pre-loaded sound from many entities, so we share one and move it
        this.soundEl.setAttribute('position', e.detail.body.el.getAttribute('position'))
        this.soundEl.components.sound.playSound()
        e.detail.target.el.body.velocity.set(0, 0, 0) // TODO: remove it
        this.el.sceneEl.emit('rock-hit-missile')
      }
    })
    AFRAME.registerComponent('player-missile', {
      dependencies: [
        'dynamic-body', 'missile-start', 'missile-collider'
      ]
    })
    AFRAME.registerComponent('space-rock', {
      dependencies: [
        'dynamic-body'
      ]
    })
    AFRAME.registerComponent('hud-score', {
      init: function () {
        this.total = 0
        this.history = []
        this.textEls = this.el.querySelectorAll('a-text')
        this.format()
        this.el.sceneEl.addEventListener('rock-hit-missile', this.rockHitMissile.bind(this))
      },
      tick: function () {
        if (this.prune()) this.format()
      },
      prune: function () {
        if (!this.history.length) return
        let tClip = Date.now() - 2000 // 2 seconds until +amount is added to total
        let expired = _.remove(this.history, e => e.ts < tClip)
        _.forEach(expired, e => { this.total += e.amount })
        return expired.length
      },
      format: function () {
        let s = '' + this.total + '\n' + this.history.map(a => '+' + a.amount).join('\n')
        _.forEach(this.textEls, (el) => el.setAttribute('value', s))
      },
      addScore: function (amount) {
        this.history.push({ ts: Date.now(), amount })
        this.prune()
        this.format()
      },
      rockHitMissile: function () {
        this.addScore(10)
      }
    })
  </script>

  <a-scene physics="gravity: 0">
    <a-assets>
      <!-- audio element broken https://github.com/aframevr/aframe/issues/2754 -->
      <a-asset-item id="themeSound" src="assets/jaws-theme.mp3" response-type="arraybuffer"></a-asset-item>
      <a-asset-item id="missileSound" src="assets/firecast.wav" response-type="arraybuffer"></a-asset-item>
      <a-asset-item id="explosionSound" src="assets/explosion-10.mp3" response-type="arraybuffer"></a-asset-item>
      <img id="skyTexture" src="assets/PIA15482_hires.jpg">
      <img id="groundTexture" src="assets/grid.png">
      <img id="rockTexture" src="assets/lunar_target.jpg">
      <img id="missileTexture" src="assets/plasma.jpg">
    </a-assets>

    <a-box space-rock position="-1 0.5 -3" rotation="0 45 0" src="#rockTexture"></a-box>
    <a-sphere space-rock dynamic-body velocity="0.3 0.1 0" position="0 1.25 -5" radius="1.25" src="#rockTexture"></a-sphere>
    <a-cylinder space-rock velocity="-0.2 -0.3 -0.1" position="1 0.75 -3" radius="0.5" height="1.5" src="#rockTexture"></a-cylinder>

    <a-entity id="rockExplosion" sound="src: #explosionSound; volume: 10" position="0 10 10"></a-entity>
    <a-sphere player-missile sound="src: #missileSound; volume: 5" position="0 3 -9" radius="1.25" src="#missileTexture" emissive="#b60"></a-sphere>

    <!-- playfield, controls, camera -->
    <a-plane sound="src: #themeSound; loop: true; autoplay: true" src="#groundTexture" position="0 0 0" rotation="-90 0 0" width="10"
      height="10" material="transparent: true"></a-plane>
    <a-sky src="#skyTexture"></a-sky>
    <a-entity camera="userHeight: 1.6" look-controls wasd-controls position="0 0.1 0">
      <a-entity cursor position="0 0 -0.5" geometry="primitive: circle; radius: 0.01; segments: 4;" material="color: #FF4444; shader: flat"></a-entity>
      <a-entity hud-score>
        <!-- shadow effect helps with readability -->
        <a-text color="white" position="0.2 0.2 -1" align="right" anchor="right" baseline="top" scale="0.2 0.2" value="Hello\nWorld"></a-text>
        <a-text color="black" position="0.205 0.205 -1.01" align="right" anchor="right" baseline="top" scale="0.2 0.2" value="Hello\nWorld"></a-text>
      </a-entity>
    </a-entity>
    <a-entity vive-controls="hand: left"></a-entity>
    <a-entity vive-controls="hand: right"></a-entity>
  </a-scene>
</body>

</html>